name: CI

on:
  push:
    branches: [master, main, develop, feature/**]
  pull_request:
    branches: [master, main, develop]
  workflow_dispatch:

jobs:
  format-check:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Install tox
        run: |
          python -m pip install --upgrade pip
          pip install tox

      - name: Check code formatting
        run: tox -e format-check

  coverage:
    name: Test Coverage
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11', '3.12', '3.13']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install tox
        run: |
          python -m pip install --upgrade pip
          pip install tox

      - name: Run tests with coverage
        run: tox -e coverage

      - name: Upload coverage to Codecov
        if: matrix.python-version == '3.13'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Archive coverage report
        if: matrix.python-version == '3.13'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/
          retention-days: 30

  lint:
    name: Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Install tox
        run: |
          python -m pip install --upgrade pip
          pip install tox

      - name: Run linting
        run: tox -e lint
        continue-on-error: true

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [format-check, coverage, lint]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "Format Check: ${{ needs.format-check.result }}"
          echo "Coverage: ${{ needs.coverage.result }}"
          echo "Lint: ${{ needs.lint.result }}"

          if [ "${{ needs.format-check.result }}" == "failure" ] || [ "${{ needs.coverage.result }}" == "failure" ]; then
            echo "❌ CI failed"
            exit 1
          else
            echo "✅ CI passed"
          fi